<nav class="cerrar">
    <div class="menu">
        <!-- Logo principal -->
        <div class="equipgo">
            <a class="navbar-brand fs-4 fw-bold text-dark text-center"
               style="font-family: 'Open Sans', sans-serif; font-weight: 700; font-size: 40px; line-height: 40px; margin: 0; padding: 0; text-decoration: none; color: #393e42;"
               href="#">EquipGO</a>
        </div>

        <!-- Menú vertical principal -->
        <div class="frame-parent">
            <!-- Dashboard -->
            <div class="user-wrapper">
                <NavLink class="user d-flex align-items-center text-white"
                         activeClass="active"
                         href="/AdminDashboard"
                         style="text-decoration: none; width: 100%;">
                    <i class="bi bi-house-door-fill casa-icon"></i>
                    <div class="usuario">
                        <b class="cerrar-equipgo">Dashboard</b>
                    </div>
                </NavLink>
            </div>

            <!-- Submenús -->
            <div class="submen">
                <!-- Usuarios -->
                <div class="usuarios menu-item">
                    <!-- <-- CAMBIO: Añadida clase "menu-item" -->
                    <div class="menu-usuarios">
                        <div class="user">
                            <div class="cerrar-usuario">
                                <div class="icono">
                                    <i class="bi bi-people-fill vector-icon"></i>
                                </div>
                            </div>
                            <div class="usuario">
                                <b class="cerrar-equipgo">Usuarios</b>
                            </div>
                        </div>
                        <i class="bi bi-caret-down-fill flecha-icon"></i>
                    </div>
                    <div class="user2">
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/usuarios/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-person-gear me-2"></i> Gestión de usuarios
                            </NavLink>
                        </div>
                    </div>
                </div>

                <!-- Equipos -->
                <div class="equipos menu-item" id="equiposContainer">
                    <!-- <-- CAMBIO: Añadida clase "menu-item" -->
                    <div class="menu-equipo">
                        <div class="user">
                            <i class="bi bi-laptop-fill computador-icon"></i>
                            <div class="usuario">
                                <b class="cerrar-equipgo">Equipos</b>
                            </div>
                        </div>
                        <i class="bi bi-caret-down-fill flecha-icon"></i>
                    </div>
                    <div class="equipos-es">
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/equipos/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-laptop me-2"></i> Administrar equipos
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/monitoreo/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-activity me-2"></i> Módulo de monitoreo
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/alertas/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-bell me-2"></i> Alertas
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/historial/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-clock-history me-2"></i> Historial
                            </NavLink>
                        </div>
                    </div>
                </div>

                <!-- Smart (Administración) -->
                <div class="equipos menu-item" id="smartContainer">
                    <!-- <-- CAMBIO: Añadida clase "menu-item" -->
                    <div class="menu-equipo">
                        <div class="user">
                            <i class="bi bi-gear-fill computador-icon"></i>
                            <div class="usuario">
                                <b class="cerrar-equipgo">Smart</b>
                            </div>
                        </div>
                        <i class="bi bi-caret-down-fill flecha-icon"></i>
                    </div>
                    <div class="equipos-es">
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/areas/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-diagram-3 me-2"></i> Áreas
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/campaña/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-megaphone me-2"></i> Campañas
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/estados/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-toggle-on me-2"></i> Estados
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/proovedor/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-truck me-2"></i> Proveedores
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/mapa/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-building me-2"></i> Sedes
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/tipos/"
                                     style="text-decoration: none; color: #393e42;">
                                <i class="bi bi-cpu me-2"></i> Tipo de dispositivos
                            </NavLink>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón para cerrar sesión -->
    <div class="user-container">
        <button class="user4 d-flex align-items-center btn btn-link"
                @onclick="CerrarSesion"
                style="text-decoration: none; color: #393e42;">
            <i class="bi bi-box-arrow-left salir-icon"></i>
            <div class="usuario">
                <b class="cerrar-equipgo">Cerrar sesión</b>
            </div>
        </button>
    </div>
</nav>

<script>
    window.initMenu = function() {
        // Selecciona todos los elementos del menú principal que tienen submenús
        const menuItems = document.querySelectorAll('.menu-item');

        menuItems.forEach(item => {
            item.addEventListener('click', function(e) {
                const clickedItem = e.currentTarget;

                // Encuentra el submenú y la flecha del elemento clicado
                const submenu = clickedItem.querySelector('.equipos-es, .user2');
                const arrow = clickedItem.querySelector('.flecha-icon');

                // --- LÓGICA DEL ACORDEÓN ---
                // Recorre todos los demás elementos del menú
                menuItems.forEach(otherItem => {
                    // Si el otro elemento no es el que se ha clicado...
                    if (otherItem !== clickedItem) {
                        const otherSubmenu = otherItem.querySelector('.equipos-es, .user2');
                        const otherArrow = otherItem.querySelector('.flecha-icon');

                        // ...cierra su submenú si estaba abierto
                        if (otherSubmenu && otherSubmenu.style.display === 'flex') {
                            otherSubmenu.style.display = 'none';
                            otherArrow.style.transform = 'rotate(0deg)';
                        }
                    }
                });
                // --- FIN DE LA LÓGICA DEL ACORDEÓN ---

                // --- LÓGICA ORIGINAL PARA ABRIR/CERRAR EL MENÚ CLICADO ---
                if (submenu.style.display === 'flex') {
                    // Si ya estaba abierto, lo cierra
                    submenu.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                } else {
                    // Si estaba cerrado, lo abre
                    submenu.style.display = 'flex';
                    arrow.style.transform = 'rotate(180deg)';
                }
            });
        });
    }
</script>

@code {
    [Inject] public IJSRuntime JS { get; set; }
    [Inject] public NavigationManager Navigation { get; set; }

    // Lógica para cerrar sesión
    private async Task CerrarSesion()
    {
        try
        {
            await JS.InvokeVoidAsync("authInterop.logout");
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cerrar sesión: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initMenu");
        }
    }
}