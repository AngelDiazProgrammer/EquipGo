<button class="hamburger-btn" onclick="window.toggleMenu()" aria-label="Abrir menú">
    <span>☰</span>
</button>


<nav class="cerrar" id="mainNav">
    <!-- Logo con imagen que ocupa todo el contenedor -->
    <div class="logo-container">
        <img src="/img/LogoEquipGO/LogotipoEquipGONavBar.png" alt="EquipGO Logo" class="logo-img" />
    </div>

    <div class="menu">
        <!-- Menú vertical principal -->
        <div class="frame-parent">
            <!-- Dashboard -->
            <div class="user-wrapper">
                <NavLink class="user d-flex align-items-center text-white"
                         activeClass="active"
                         href="/AdminDashboard"
                         style="text-decoration: none; width: 100%;">
                    <div class="usuario">
                        <b class="cerrar-equipgo">Dashboard</b>
                    </div>
                </NavLink>
            </div>

            <!-- Submenús -->
            <div class="submen">
                <!-- Usuarios -->
                <div class="usuarios menu-item" id="menuUsuarios">
                    <div class="menu-usuarios">
                        <div class="user">
                            <div class="usuario">
                                <b class="cerrar-equipgo">Usuarios</b>
                            </div>
                        </div>
                        <i class="bi bi-caret-down-fill flecha-icon"></i>
                    </div>
                    <div class="user2">
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/usuarios/"
                                     style="text-decoration: none; color: #393e42;">
                                Gestión de usuarios
                            </NavLink>
                        </div>
                    </div>
                </div>

                <!-- Equipos -->
                <div class="equipos menu-item" id="menuEquipos">
                    <div class="menu-equipo">
                        <div class="user">
                            <div class="usuario">
                                <b class="cerrar-equipgo">Equipos</b>
                            </div>
                        </div>
                        <i class="bi bi-caret-down-fill flecha-icon"></i>
                    </div>
                    <div class="equipos-es">
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/equipos/"
                                     style="text-decoration: none; color: #393e42;">
                                Administrar equipos
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/monitoreo/"
                                     style="text-decoration: none; color: #393e42;">
                                Módulo de monitoreo
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/alertas/"
                                     style="text-decoration: none; color: #393e42;">
                                Alertas
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/historial/"
                                     style="text-decoration: none; color: #393e42;">
                                Historial
                            </NavLink>
                        </div>
                    </div>
                </div>

                <!-- Smart (Administración) -->
                <div class="equipos menu-item" id="menuSmart">
                    <div class="menu-equipo">
                        <div class="user">
                            <div class="usuario">
                                <b class="cerrar-equipgo">Smart</b>
                            </div>
                        </div>
                        <i class="bi bi-caret-down-fill flecha-icon"></i>
                    </div>
                    <div class="equipos-es">
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/areas/"
                                     style="text-decoration: none; color: #393e42;">
                                Áreas
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/campaña/"
                                     style="text-decoration: none; color: #393e42;">
                                Campañas
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/subestados/"
                                     style="text-decoration: none; color: #393e42;">
                                Estados
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/proovedor/"
                                     style="text-decoration: none; color: #393e42;">
                                Proveedores
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/mapa/"
                                     style="text-decoration: none; color: #393e42;">
                                Sedes
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/tipos/"
                                     style="text-decoration: none; color: #393e42;">
                                Tipo de dispositivos
                            </NavLink>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón para cerrar sesión -->
    <div class="user-container">
        <button class="user4 d-flex align-items-center btn btn-link"
                @onclick="CerrarSesion"
                style="text-decoration: none; color: #393e42;">
            <div class="usuario">
                <b class="cerrar-equipgo">Cerrar sesión</b>
            </div>
        </button>
    </div>
</nav>

<script>

  
    window.initMenu = function() {
        const menuItems = document.querySelectorAll('.menu-item');

        menuItems.forEach(item => {
            const header = item.querySelector('.menu-usuarios, .menu-equipo');
            const submenu = item.querySelector('.equipos-es, .user2');
            const arrow = item.querySelector('.flecha-icon');

            header.addEventListener('click', function(e) {
                e.stopPropagation();

                // Lógica del acordeón
                menuItems.forEach(otherItem => {
                    if (otherItem !== item) {
                        const otherSubmenu = otherItem.querySelector('.equipos-es, .user2');
                        const otherArrow = otherItem.querySelector('.flecha-icon');

                        if (otherSubmenu && otherSubmenu.style.display === 'flex') {
                            otherSubmenu.style.display = 'none';
                            otherArrow.style.transform = 'rotate(0deg)';
                            otherItem.classList.remove('expanded');
                        }
                    }
                });

                // Abrir/cerrar menú clicado
                if (submenu.style.display === 'flex') {
                    submenu.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                    item.classList.remove('expanded');
                } else {
                    submenu.style.display = 'flex';
                    arrow.style.transform = 'rotate(180deg)';
                    item.classList.add('expanded');
                }
            });

            // Evitar que el clic en el submenú cierre el menú
            if (submenu) {
                submenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });

        // Inicializar detección de menú activo
        checkActiveMenu();
    }

    // Función para verificar y marcar el menú activo
    function checkActiveMenu() {
        // Remover resaltado de todos los menús primero
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active-parent');
        });

        // Buscar elementos activos en los submenús
        const activeSubItems = document.querySelectorAll('.administrar .active');

        activeSubItems.forEach(activeItem => {
            // Encontrar el menú padre del elemento activo
            let parent = activeItem.closest('.user2, .equipos-es');
            if (parent) {
                let menuItem = parent.closest('.menu-item');
                if (menuItem) {
                    menuItem.classList.add('active-parent');
                    // Asegurar que el submenú esté expandido
                    const submenu = menuItem.querySelector('.equipos-es, .user2');
                    const arrow = menuItem.querySelector('.flecha-icon');
                    if (submenu) {
                        submenu.style.display = 'flex';
                        arrow.style.transform = 'rotate(180deg)';
                        menuItem.classList.add('expanded');
                    }
                }
            }
        });

        // También verificar después de un pequeño delay para asegurar que Blazor haya aplicado las clases
        setTimeout(() => {
            const activeSubItemsDelay = document.querySelectorAll('.administrar .active');
            activeSubItemsDelay.forEach(activeItem => {
                let parent = activeItem.closest('.user2, .equipos-es');
                if (parent) {
                    let menuItem = parent.closest('.menu-item');
                    if (menuItem) {
                        menuItem.classList.add('active-parent');
                        // Asegurar que el submenú esté expandido
                        const submenu = menuItem.querySelector('.equipos-es, .user2');
                        const arrow = menuItem.querySelector('.flecha-icon');
                        if (submenu) {
                            submenu.style.display = 'flex';
                            arrow.style.transform = 'rotate(180deg)';
                            menuItem.classList.add('expanded');
                        }
                    }
                }
            });
        }, 100);
    }

    // Llamar a checkActiveMenu cuando cambie la ruta
    window.addEventListener('popstate', checkActiveMenu);

    // Para Blazor: llamar esta función cuando se navegue
    window.navigationHandler = function() {
        setTimeout(checkActiveMenu, 150);
    }


    function toggleMenu() {
      const nav = document.querySelector('.cerrar');
      if (!nav) {
        console.error('toggleMenu: no se encontró .cerrar');
        return;
      }
      nav.classList.toggle('mobile-open');
    }

    // Conectar el botón de forma segura después de cargar DOM
    document.addEventListener('DOMContentLoaded', function () {
      const btn = document.getElementById('hamburgerBtn');
      if (!btn) {
        console.error('No se encontró #hamburgerBtn');
        return;
      }
      btn.addEventListener('click', toggleMenu);
    });

        window.toggleMenu = function () {
        const nav = document.querySelector('.cerrar');
        if (!nav) return;
        nav.classList.toggle('mobile-open');
    };
</script>
@code {
    [Inject] public IJSRuntime JS { get; set; }
    [Inject] public NavigationManager Navigation { get; set; }

    // Lógica para cerrar sesión
    private async Task CerrarSesion()
    {
        try
        {
            await JS.InvokeVoidAsync("authInterop.logout");
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cerrar sesión: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initMenu");
        }
    }
}