<button class="hamburger-btn" onclick="window.toggleMenu()" aria-label="Abrir menú">
    <span>☰</span>
</button>


<nav class="cerrar" id="mainNav">
    <!-- Logo con imagen que ocupa todo el contenedor -->
    <div class="logo-container">
        <img src="/img/LogoEquipGO/LogotipoEquipGONavBar.png" alt="EquipGO Logo" class="logo-img" />
    </div>

    <div class="menu">
        <!-- Menú vertical principal -->
        <div class="frame-parent">
            <!-- Dashboard -->
            <div class="user-wrapper">
                <NavLink class="user d-flex align-items-center text-white"
                         activeClass="active"
                         href="/AdminDashboard"
                         style="text-decoration: none; width: 100%;">
                    <div class="usuario">
                        <b class="cerrar-equipgo">Dashboard</b>
                    </div>
                </NavLink>
            </div>

            <!-- Submenús -->
            <div class="submen">
                <!-- Equipos -->
                <div class="equipos menu-item" id="menuEquipos">
                    <div class="menu-equipo">
                        <div class="user">
                            <div class="usuario">
                                <b class="cerrar-equipgo">Equipos</b>
                            </div>
                        </div>
                        <i class="bi bi-caret-down-fill flecha-icon"></i>
                    </div>
                    <div class="equipos-es">
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/equipos/"
                                     style="text-decoration: none; color: #393e42; margin-left: 5px; width: 100%; height: 100%;">
                                Administrar equipos
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/subestados/"
                                     style="text-decoration: none; color: #393e42; margin-left: 5px; width: 100%; height: 100%">
                                Subestados
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/monitoreo/"
                                     style="text-decoration: none; color: #393e42; margin-left: 5px; width: 100%; height: 100%">
                                Módulo de monitoreo
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/alertas/"
                                     style="text-decoration: none; color: #393e42; margin-left: 5px; width: 100%; height: 100%">
                                Alertas
                            </NavLink>
                        </div>
                    </div>
                </div>
                <!-- Usuarios -->
                <div class="usuarios menu-item" id="menuUsuarios">
                    <div class="menu-usuarios">
                        <div class="user">
                            <div class="usuario">
                                <b class="cerrar-equipgo">Usuarios</b>
                            </div>
                        </div>
                        <i class="bi bi-caret-down-fill flecha-icon"></i>
                    </div>
                    <div class="user2">
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/usuarios/"
                                     style="text-decoration: none; color: #393e42; margin-left: 5px; width: 100%; height: 100%">
                                Gestión de usuarios
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/usuariosSession/"
                                     style="text-decoration: none; color: #393e42; margin-left: 5px; width: 100%; height: 100%">
                                Gestión de logueo
                            </NavLink>
                        </div>
                    </div>
                </div>

                <!-- Transacciones -->
                <div class="equipos menu-item" id="menuTransacciones">
                    <div class="menu-equipo">
                        <div class="user">
                            <div class="usuario">
                                <b class="cerrar-equipgo">Transacciones</b>
                            </div>
                        </div>
                        <i class="bi bi-caret-down-fill flecha-icon"></i>
                    </div>
                    <div class="equipos-es">
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/transaccionesCorporativos/"
                                     style="text-decoration: none; color: #393e42; margin-left: 5px; width: 100%; height: 100%">
                                Corporativos
                            </NavLink>
                        </div>
                        <div class="administrar">
                            <NavLink class="administrar-equipos d-flex align-items-center"
                                     activeClass="active"
                                     href="/transaccionesVisitantes/"
                                     style="text-decoration: none; color: #393e42; margin-left: 5px; width: 100%; height: 100%">
                                Visitantes
                            </NavLink>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón para cerrar sesión -->
    <div class="user-container">
        <button class="user4 d-flex align-items-center btn btn-link"
                @onclick="CerrarSesion"
                style="text-decoration: none; color: #393e42;">
            <div class="usuario">
                <b class="cerrar-equipgo">Cerrar sesión</b>
            </div>
        </button>
    </div>
</nav>


<script>
    window.initMenu = function() {
        const menuItems = document.querySelectorAll('.menu-item');

        menuItems.forEach(item => {
            const header = item.querySelector('.menu-usuarios, .menu-equipo');
            const submenu = item.querySelector('.equipos-es, .user2');
            const arrow = item.querySelector('.flecha-icon');

            header.addEventListener('click', function(e) {
                e.stopPropagation();

                // Lógica del acordeón
                menuItems.forEach(otherItem => {
                    if (otherItem !== item) {
                        const otherSubmenu = otherItem.querySelector('.equipos-es, .user2');
                        const otherArrow = otherItem.querySelector('.flecha-icon');

                        if (otherSubmenu && otherSubmenu.style.display === 'flex') {
                            otherSubmenu.style.display = 'none';
                            otherArrow.style.transform = 'rotate(0deg)';
                            otherItem.classList.remove('expanded');
                        }
                    }
                });

                // Abrir/cerrar menú clicado
                if (submenu.style.display === 'flex') {
                    submenu.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                    item.classList.remove('expanded');
                } else {
                    submenu.style.display = 'flex';
                    arrow.style.transform = 'rotate(180deg)';
                    item.classList.add('expanded');
                }
            });

            if (submenu) {
                submenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });

        checkActiveMenu();
    }

    function checkActiveMenu() {
        // Remover todas las clases activas
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active-parent');
        });

        document.querySelectorAll('.administrar').forEach(item => {
            item.classList.remove('active-submenu');
        });

        // Buscar el link activo dentro de los submenús
        const activeLinks = document.querySelectorAll('.administrar-equipos.active');

        activeLinks.forEach(activeLink => {
            // Marcar el contenedor del subitem como activo
            let adminDiv = activeLink.closest('.administrar');
            if (adminDiv) {
                adminDiv.classList.add('active-submenu');
            }

            // Expandir el menú padre
            let submenu = activeLink.closest('.user2, .equipos-es');
            if (submenu) {
                let menuItem = submenu.closest('.menu-item');
                if (menuItem) {
                    const arrow = menuItem.querySelector('.flecha-icon');
                    submenu.style.display = 'flex';
                    if (arrow) {
                        arrow.style.transform = 'rotate(180deg)';
                    }
                    menuItem.classList.add('expanded');
                }
            }
        });

        // Verificar después de delay para Blazor
        setTimeout(() => {
            const delayedActiveLinks = document.querySelectorAll('.administrar-equipos.active');
            delayedActiveLinks.forEach(activeLink => {
                let adminDiv = activeLink.closest('.administrar');
                if (adminDiv) {
                    adminDiv.classList.add('active-submenu');
                }

                let submenu = activeLink.closest('.user2, .equipos-es');
                if (submenu) {
                    let menuItem = submenu.closest('.menu-item');
                    if (menuItem) {
                        const arrow = menuItem.querySelector('.flecha-icon');
                        submenu.style.display = 'flex';
                        if (arrow) {
                            arrow.style.transform = 'rotate(180deg)';
                        }
                        menuItem.classList.add('expanded');
                    }
                }
            });
        }, 100);
    }

    window.addEventListener('popstate', checkActiveMenu);

    window.navigationHandler = function() {
        setTimeout(checkActiveMenu, 150);
    }

    window.toggleMenu = function () {
        const nav = document.querySelector('.cerrar');
        if (!nav) return;
        nav.classList.toggle('mobile-open');
    };
</script>

@code {
    [Inject] public IJSRuntime JS { get; set; }
    [Inject] public NavigationManager Navigation { get; set; }

    // Lógica para cerrar sesión
    private async Task CerrarSesion()
    {
        try
        {
            await JS.InvokeVoidAsync("authInterop.logout");
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cerrar sesión: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initMenu");
        }
    }
}