@page "/alertas"
@using OUT_OS_APP.EQUIPGO.DTO.DTOs.Alertas
@using OUT_APP_EQUIPGO.Components.Shared

<div class="frame-container">
    <!-- Encabezado -->
    <div class="dashboard-parent">
        <h4 class="dashboard-equipgo">Sistema de Alertas</h4>
        <div class="logo-os">
            <img src="img/logoOutsourcing.png" alt="Logo" class="dashboard-vector-icon" />
        </div>
    </div>

    <!-- Contadores de Alertas -->
    <div class="info">
        <div class="card-registros">
            <div class="datos">
                <span class="b">@TotalAlertas</span>
                <span class="transacciones-de-hoy">Total Alertas</span>
            </div>
        </div>
        <div class="dashboard-card-registros">
            <div class="datos">
                <span class="b">@AlertasHoy</span>
                <span class="transacciones-de-hoy">Alertas Hoy</span>
            </div>
        </div>
        <div class="card-alerta">
            <div class="datos">
                <span class="b">@AlertasCriticas</span>
                <span class="transacciones-de-hoy">Alertas Críticas</span>
            </div>
        </div>
        <div class="card-bloqueo">
            <div class="datos">
                <span class="b">@EquiposBloqueadosCount</span>
                <span class="transacciones-de-hoy">Equipos Bloqueados</span>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="contenido">

        <!-- FILTROS CORREGIDOS -->
        <div class="dashboard-filtros">
            <div class="dashboard-filtro">
                <div class="buscar-nombre">
                    <label>Serial Equipo</label>
                    <div class="frame-div">
                        <input type="text"
                               class="placeholder"
                               value="@filtroSerial"
                               @oninput="OnFiltroSerialChanged"
                               placeholder="Filtrar por serial..." />
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label>Marca</label>
                    <div class="frame-div">
                        <input type="text"
                               class="placeholder"
                               value="@filtroMarca"
                               @oninput="OnFiltroMarcaChanged"
                               placeholder="Filtrar por marca..." />
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label>Tipo Alerta</label>
                    <div class="dashboard-contenido">
                        <select value="@filtroTipoAlerta" @onchange="OnFiltroTipoAlertaChanged">
                            <option value="">Todos los tipos</option>
                            @foreach (var tipo in tiposAlerta)
                            {
                                <option value="@tipo.Id">@tipo.NombreAlerta</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label>Fecha Desde</label>
                    <div class="frame-div">
                        <input type="date"
                               class="placeholder"
                               value="@filtroFechaDesde?.ToString("yyyy-MM-dd")"
                               @onchange="OnFiltroFechaDesdeChanged" />
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label>Fecha Hasta</label>
                    <div class="frame-div">
                        <input type="date"
                               class="placeholder"
                               value="@filtroFechaHasta?.ToString("yyyy-MM-dd")"
                               @onchange="OnFiltroFechaHastaChanged" />
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label class="checkbox-label">
                        <input type="checkbox"
                               checked="@soloBloqueados"
                               @onchange="OnSoloBloqueadosChanged" />
                        Solo Equipos Bloqueados
                    </label>
                </div>
            </div>
        </div>

        <!-- Botonera -->
        <div class="botonera">
            <button class="botn3" @onclick="LimpiarFiltros">
                <i class="bi bi-arrow-clockwise"></i> Limpiar Filtros
            </button>
            <button class="botn3" @onclick="() => RefrescarAlertas()">
                <i class="bi bi-arrow-repeat"></i> Actualizar
            </button>
        </div>

        <!-- Loader -->
        @if (isCargandoAlertas)
        {
            <div class="loader-container">
                <div class="loader-spinner"></div>
                <p>Cargando alertas...</p>
            </div>
        }

        <!-- Tabla de Alertas -->
        @if (alertasPaginadas == null)
        {
            <p>Cargando alertas...</p>
        }
        else if (alertasPaginadas.Any())
        {
            <div class="table-wrapper">
                <table class="table-equipgo">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Serial</th>
                            <th>Equipo</th>
                            <th>Tipo Alerta</th>
                            <th>Descripción</th>
                            <th>Contador</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var alerta in alertasPaginadas)
                        {
                            <tr class="@(alerta.EstaBloqueado ? "fila-bloqueada" : "")">
                                <td>@alerta.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@alerta.SerialEquipo</td>
                                <td>@alerta.MarcaEquipo @alerta.ModeloEquipo</td>
                                <td>
                                    <span class="badge @GetBadgeClass(alerta.IdTipoAlerta)">
                                        @alerta.NombreAlerta
                                    </span>
                                </td>
                                <td>@alerta.Descripcion</td>
                                <td>
                                    <span class="contador @(alerta.Contador >= 5 ? "contador-critico" : alerta.Contador >= 3 ? "contador-advertencia" : "")">
                                        @alerta.Contador
                                    </span>
                                </td>
                                <td>
                                    @if (alerta.EstaBloqueado)
                                    {
                                        <span class="badge bg-danger">BLOQUEADO</span>
                                    }
                                    else if (alerta.Contador >= 3)
                                    {
                                        <span class="badge bg-warning">EN RIESGO</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">NORMAL</span>
                                    }
                                </td>
                                <td>
                                    @if (alerta.EstaBloqueado)
                                    {
                                        <button class="btn btn-sm btn-success"
                                                @onclick="() => DesbloquearEquipo(alerta.SerialEquipo, alerta.Id)"
                                                title="Desbloquear Equipo">
                                            <i class="bi bi-check-circle"></i> Desbloquear
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- COMPONENTE DE PAGINACIÓN -->
            <Paginacion TotalRegistros="@alertasFiltradas.Count"
                        PaginaActual="@paginaActual"
                        PaginaActualChanged="@OnPaginaCambiada"
                        RegistrosPorPagina="@registrosPorPagina"
                        RegistrosPorPaginaChanged="@OnRegistrosPorPaginaCambiados"
                        ModoAuto="@modoAuto"
                        ModoAutoChanged="@( (bool nuevoModo) => modoAuto = nuevoModo )" />
        }
        else
        {
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No hay alertas que coincidan con los filtros aplicados.
            </div>
        }
    </div>
</div>

@code {
    private string GetBadgeClass(int idTipoAlerta)
    {
        return idTipoAlerta switch
        {
            1 => "bg-warning",   // Primera notificación
            2 => "bg-orange",    // Segunda notificación
            3 => "bg-danger",    // Tercera notificación
            4 => "bg-dark",      // Bloqueo
            _ => "bg-secondary"
        };
    }
}

<style>
    .fila-bloqueada {
        background-color: #fff5f5 !important;
        border-left: 4px solid #dc3545;
    }

    .contador {
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: bold;
        background: #e9ecef;
    }

    .contador-advertencia {
        background: #fff3cd;
        color: #856404;
    }

    .contador-critico {
        background: #f8d7da;
        color: #721c24;
    }

    .bg-orange {
        background-color: #fd7e14 !important;
    }

    .loader-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .loader-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

</style>