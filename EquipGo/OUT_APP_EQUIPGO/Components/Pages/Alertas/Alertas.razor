@page "/alertas"
@using OUT_OS_APP.EQUIPGO.DTO.DTOs.Alertas
@using OUT_APP_EQUIPGO.Components.Shared

<div class="frame-container">
    <!-- Encabezado -->
    <div class="dashboard-parent">
        <div>
            <div>
                <b class="dashboard-equipgo">Sistema de Alertas</b>
            </div>
            <div>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Visualiza y administra las alertas generadas por los equipos fuera de sede sin una autorizacion de salida.
                </small>
            </div>
        </div>
        <div class="logo-os">
            <img src="img/logoOutsourcing.png" alt="Logo" class="dashboard-vector-icon" />
        </div>
    </div>

    <!-- Contadores de Alertas -->
    <div class="info">
        <div class="card-registros">
            <div class="datos">
                <span class="b">@TotalAlertas</span>
                <span class="transacciones-de-hoy">Total Alertas</span>
            </div>
        </div>
        <div class="dashboard-card-registros">
            <div class="datos">
                <span class="b">@AlertasHoy</span>
                <span class="transacciones-de-hoy">Alertas Hoy</span>
            </div>
        </div>
        <div class="card-alerta">
            <div class="datos">
                <span class="b">@AlertasCriticas</span>
                <span class="transacciones-de-hoy">Alertas Críticas</span>
            </div>
        </div>
        <div class="card-bloqueo">
            <div class="datos">
                <span class="b">@EquiposBloqueadosCount</span>
                <span class="transacciones-de-hoy">Equipos Bloqueados</span>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="contenido">

        <!-- FILTROS CORREGIDOS -->
        <div class="dashboard-filtros">
            <div class="dashboard-filtro">
                 <div class="buscar-nombre">
                    <label>Usuario Asignado</label>
                    <div class="frame-div">
                        <input type="text"
                               class="placeholder"
                               value="@filtroUsuario"
                               @oninput="OnFiltroUsuarioChanged"
                               placeholder="Filtrar por usuario..." />
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label>Serial Equipo</label>
                    <div class="frame-div">
                        <input type="text"
                               class="placeholder"
                               value="@filtroSerial"
                               @oninput="OnFiltroSerialChanged"
                               placeholder="Filtrar por serial..." />
                    </div>
                </div>

                <div class="buscar-nombre">
                    <label>Marca</label>
                    <div class="frame-div">
                        <input type="text"
                               class="placeholder"
                               value="@filtroMarca"
                               @oninput="OnFiltroMarcaChanged"
                               placeholder="Filtrar por marca..." />
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label>Tipo Alerta</label>
                    <div class="dashboard-contenido">
                        <select value="@filtroTipoAlerta" @onchange="OnFiltroTipoAlertaChanged">
                            <option value="">Todos los tipos</option>
                            @foreach (var tipo in tiposAlerta)
                            {
                                <option value="@tipo.Id">@tipo.NombreAlerta</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label>Fecha Desde</label>
                    <div class="frame-div">
                        <input type="date"
                               class="placeholder"
                               value="@filtroFechaDesde?.ToString("yyyy-MM-dd")"
                               @onchange="OnFiltroFechaDesdeChanged" />
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label>Fecha Hasta</label>
                    <div class="frame-div">
                        <input type="date"
                               class="placeholder"
                               value="@filtroFechaHasta?.ToString("yyyy-MM-dd")"
                               @onchange="OnFiltroFechaHastaChanged" />
                    </div>
                </div>
                <div class="buscar-nombre">
                    <label class="checkbox-label">
                        <input type="checkbox"
                               checked="@soloBloqueados"
                               @onchange="OnSoloBloqueadosChanged" />
                        Solo Equipos Bloqueados
                    </label>
                </div>
            </div>
        </div>

        <!-- Botonera -->
        <div class="botonera">
            <button class="botn3" @onclick="() => RefrescarAlertas()">
                Actualizar
            </button>
        </div>

        <!-- Loader -->
        @if (isCargandoAlertas)
        {
            <div class="loader-container">
                <div class="loader-spinner"></div>
                <p>Cargando alertas...</p>
            </div>
        }

        <!-- Tabla de Alertas -->
        @if (alertasPaginadas == null)
        {
            <p>Cargando alertas...</p>
        }
        else if (alertasPaginadas.Any())
        {
            <div class="table-wrapper">
                <table class="table-equipgo">
                    <thead>
                        <tr>
                            <th>Usuario Asigando</th>
                            <th>Fecha/Hora</th>
                            <th>Serial</th>
                            <th>Equipo</th>
                            <th>Nivel de prioridad</th>
@*                             <th>Descripción</th> *@
                            <th>Contadeo de alertas</th>
@*                             <th>Estado</th> *@
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var alerta in alertasPaginadas)
                        {
                            <tr class="@(alerta.EstaBloqueado ? "fila-bloqueada" : "")">
                                <td>@if(!string.IsNullOrEmpty(alerta.UsuarioAsignado))
                                    {
                                        <span>@alerta.UsuarioAsignado</span>
                                    }
                                    else
                                    {
                                        <span>Sin asignar</span>
                                    }
                                </td>
                                <td>@alerta.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@alerta.SerialEquipo</td>
                                <td>@alerta.MarcaEquipo @alerta.ModeloEquipo</td>
                                <td>
                                    <span class="@GetBadgeClass(alerta.IdTipoAlerta)">
                                        @alerta.NombreAlerta
                                    </span>
                                </td>
                                @* <td>@alerta.Descripcion</td> *@
                                <td>
                                    <span class="contador @(alerta.Contador >= 5 ? "contador-critico" : alerta.Contador >= 3 ? "contador-advertencia" : "")">
                                        @alerta.Contador
                                    </span>
                                </td>
@*                                 <td>
                                    @if (alerta.EstaBloqueado)
                                    {
                                        <span class="badge bg-danger">BLOQUEADO</span>
                                    }
                                    else if (alerta.Contador >= 3)
                                    {
                                        <span class="badge bg-warning">EN RIESGO</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">NORMAL</span>
                                    }
                                </td> *@
                                <td>
                                    <button class="btn btn-sm btn-outline-info"
                                        @onclick="() => AbrirModalDetalles(alerta)"
                                        title="Ver Detalles">
                                        🔎
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning"
                                            @onclick="() => VerUbicacionEquipo(alerta.SerialEquipo)"
                                            title="Ver Ubicación">
                                        🗺️
                                    </button>
                                    @if (alerta.EstaBloqueado)
                                    {
                                        <button class="btn btn-sm btn-outline-success"
                                                @onclick="() => DesbloquearEquipo(alerta.SerialEquipo, alerta.Id)"
                                                title="Desbloquear Equipo">
                                            🔓
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="text-muted"></span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- COMPONENTE DE PAGINACIÓN -->
            <Paginacion TotalRegistros="@alertasFiltradas.Count"
                        PaginaActual="@paginaActual"
                        PaginaActualChanged="@OnPaginaCambiada"
                        RegistrosPorPagina="@registrosPorPagina"
                        RegistrosPorPaginaChanged="@OnRegistrosPorPaginaCambiados"
                        ModoAuto="@modoAuto"
                        ModoAutoChanged="@( (bool nuevoModo) => modoAuto = nuevoModo )" />
        }
        else
        {
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No hay alertas que coincidan con los filtros aplicados.
            </div>
        }
    </div>


    <!-- Modal Detalles Alerta -->
    @if (mostrarModalDetalles)
    {
        <div class="modal fade modal-equipgo show d-block" tabindex="-1" aria-labelledby="modalDetallesAlertaLabel" aria-hidden="false" style="background-color: rgba(0,0,0,0.5)">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header-equipgo">
                        <h5 class="modal-title-equipgo">Detalles de la Alerta</h5>
                        <button type="button" class="btn-close" @onclick="CerrarModalDetalles" aria-label="Close"></button>
                    </div>
                    <div class="modal-body-equipgo">
                        @if (alertaSeleccionada != null)
                        {
                            <!-- Sección 1: Información del Equipo -->
                            <div class="seccion-modal">
                                <div class="seccion-header">
                                    <span class="seccion-titulo">💻 Información del Equipo</span>
                                </div>
                                <div class="seccion-datos">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-section">
                                                <label><strong>Serial</strong></label>
                                                <div class="dato-fila">
                                                    <span class="dato-valor">@alertaSeleccionada.SerialEquipo</span>
                                                </div>
                                                <small class="text-muted">
                                                    Identificador único del equipo en el sistema
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-section">
                                                <label><strong>Marca</strong></label>
                                                <div class="dato-fila">
                                                    <span class="dato-valor">@alertaSeleccionada.MarcaEquipo</span>
                                                </div>
                                                <small class="text-muted">
                                                    Fabricante del equipo tecnológico
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-section">
                                                <label><strong>Modelo</strong></label>
                                                <div class="dato-fila">
                                                    <span class="dato-valor">@alertaSeleccionada.ModeloEquipo</span>
                                                </div>
                                                <small class="text-muted">
                                                    Modelo específico del equipo
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Sección 2: Información del Usuario -->
                            <div class="seccion-modal">
                                <div class="seccion-header">
                                    <span class="seccion-titulo">👤 Usuario Asignado</span>
                                </div>
                                <div class="seccion-datos">
                                    <div class="form-section">
                                        <div class="dato-fila">
                                            @if (!string.IsNullOrEmpty(alertaSeleccionada.UsuarioAsignado))
                                            {
                                                <span class="">@alertaSeleccionada.UsuarioAsignado</span>
                                            }
                                            else
                                            {
                                                <span class="">Sin asignar</span>
                                            }
                                    </div>
                                    <small class="text-muted">
                                        @(!string.IsNullOrEmpty(alertaSeleccionada.UsuarioAsignado) ?
                                                                            "Usuario responsable del equipo en este momento" :
                                                                            "Equipo disponible para asignación")
                                </small>
                            </div>
                        </div>
                    </div>
                            <!-- Sección 3: Información de la Alerta -->
                            <div class="seccion-modal">
                                <div class="seccion-header">
                                    <span class="seccion-titulo">⚠️ Información de la Alerta</span>
                                </div>
                                <div class="seccion-datos">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-section">
                                                <label><strong>Tipo de Alerta</strong></label>
                                                <div class="dato-fila">
                                                    <span class="@GetBadgeClass(alertaSeleccionada.IdTipoAlerta)">
                                                        @alertaSeleccionada.NombreAlerta
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    @GetDescripcionTipoAlerta(alertaSeleccionada.IdTipoAlerta)
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-section">
                                                <label><strong>Fecha y Hora</strong></label>
                                                <div class="dato-fila">
                                                    <span class="dato-valor">@alertaSeleccionada.Fecha.ToString("dd/MM/yyyy HH:mm:ss")</span>
                                                </div>
                                                <small class="text-muted">
                                                    Momento exacto en que se generó la alerta en el sistema
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-section">
                                        <label><strong>Descripción</strong></label>
                                        <div class="dato-fila">
                                            <span class="dato-valor">@alertaSeleccionada.Descripcion</span>
                                        </div>
                                        <small class="text-muted">
                                            Detalle específico de lo que activó esta alerta en el sistema de geofencing
                                        </small>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-section">
                                                <label><strong>Contador de Alertas</strong></label>
                                                <div class="dato-fila">
                                                    <span class="contador @(alertaSeleccionada.Contador >= 5 ? "contador-critico" : alertaSeleccionada.Contador >= 3 ? "contador-advertencia" : "")">
                                                        @alertaSeleccionada.Contador
                                                    </span>
                                                </div>
                                                <small class="text-muted">
                                                    @GetDescripcionContador(alertaSeleccionada.Contador)
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-section">
                                                <label><strong>Estado del Equipo</strong></label>
                                                <div class="dato-fila">
                                                    @if (alertaSeleccionada.EstaBloqueado)
                                                    {
                                                        <span class="">BLOQUEADO</span>
                                                    }
                                                    else if (alertaSeleccionada.Contador >= 3)
                                                    {
                                                        <span class="">EN RIESGO</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="">NORMAL</span>
                                                    }
                                                </div>
                                                <small class="text-muted">
                                                    @GetDescripcionEstado(alertaSeleccionada.EstaBloqueado, alertaSeleccionada.Contador)
                                                </small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-section">
                                                <label><strong>Revisada por Operador</strong></label>
                                                <div class="dato-fila">
                                                    @if (alertaSeleccionada.FueRevisada)
                                                    {
                                                        <span class="">SÍ</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="">NO</span>
                                                    }
                                            </div>
                                            <small class="text-muted">
                                                @(alertaSeleccionada.FueRevisada ?
                                                                                            "Esta alerta ya fue revisada y gestionada" :
                                                                                            "Alerta pendiente de revisión")
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                                        }
                    </div>
                    <div class="modal-footer-equipgo">
                        <button class="boton-modal-equipgo" @onclick="CerrarModalDetalles">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .fila-bloqueada {
        background-color: #fff5f5 !important;
        border-left: 4px solid #dc3545;
    }

    .contador {
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: bold;
        background: #e9ecef;
    }

    .contador-advertencia {
        background: #fff3cd;
        color: #856404;
    }

    .contador-critico {
        background: #f8d7da;
        color: #721c24;
    }

    .bg-orange {
        background-color: #fd7e14 !important;
    }

    .loader-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .loader-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

</style>