@page "/usuariosSession"
@using Microsoft.AspNetCore.Authorization
@using OUT_OS_APP.EQUIPGO.DTO.DTOs.Usuarios
@using OUT_APP_EQUIPGO.Components.Shared

<link href="css/Dashboard/dashboard.css" rel="stylesheet" />

<div class="frame-container">
    <!-- ENCABEZADO -->
    <div class="dashboard-parent">
        <div>
            <div>
                <b class="dashboard-equipgo">Gestión de usuarios informativos</b>
            </div>
            <div>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Gestiona las cuentas de los usuarios que ingresan al sistema, incluyendo roles y estado de acceso.
                </small>
            </div>
        </div>
        <div class="logo-os">
            <img class="dashboard-vector-icon" alt="Logo" src="img/logoOutsourcing.png" />
        </div>
    </div>

    <!-- CONTADORES -->
    <div class="info">
        <div class="card-registros">
            <div class="datos">
                <b class="b">@TotalUsuarios</b>
                <b class="transacciones-de-hoy">Total Usuarios</b>
            </div>
        </div>

        <div class="dashboard-card-registros">
            <div class="datos">
                <b class="b">@UsuariosActivos</b>
                <b class="transacciones-de-hoy">Usuarios Activos</b>
            </div>
        </div>

        <div class="card-alerta">
            <div class="datos">
                <b class="b">@UsuariosInactivos</b>
                <b class="transacciones-de-hoy">Usuarios Inactivos</b>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="contenido">
        <!-- FILTROS ACTUALIZADOS -->
        <div class="dashboard-filtros">
            <div class="dashboard-filtro">
                <!-- Filtro por Número de Documento -->
                <div class="buscar-nombre">
                    <label>N° Documento</label>
                    <div class="frame-div">
                        <div class="placeholder-wrapper">
                            <input type="text"
                                   class="placeholder"
                                   @bind="filtroNumeroDocumento"
                                   @oninput="OnFiltroNumeroDocumentoChanged"
                                   placeholder="Buscar por documento..." />
                        </div>
                    </div>
                </div>

                <!-- Filtro por Nombre Completo -->
                <div class="buscar-nombre">
                    <label>Nombre Completo</label>
                    <div class="frame-div">
                        <div class="placeholder-wrapper">
                            <input type="text"
                                   class="placeholder"
                                   @bind="filtroNombreCompleto"
                                   @oninput="OnFiltroNombreCompletoChanged"
                                   placeholder="Buscar por nombre..." />
                        </div>
                    </div>
                </div>

                <!-- Filtro por Rol -->
                <div class="buscar-nombre">
                    <label>Rol</label>
                    <div class="frame-div">
                        <div class="placeholder-wrapper">
                            <input type="text"
                                   class="placeholder"
                                   @bind="filtroRol"
                                   @oninput="OnFiltroRolChanged"
                                   placeholder="Filtrar por rol..." />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="botonera">
            <button class="botn3" @onclick="AbrirModalCrearUsuario">
                 Añadir
            </button>
        </div>

        <!-- TABLA CON PAGINACIÓN BLAZOR -->
        @if (isCargandoUsuarios)
        {
            <div class="loading-overlay">
                <div class="spinner-container">
                    <div class="spinner-equipgo"></div>
                </div>
                <p class="loading-text">Cargando usuarios...</p>
            </div>
        }
        else if (!usuariosPaginados.Any())
        {
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No hay usuarios que coincidan con los filtros.
            </div>
        }
        else
        {
            <div class="table-wrapper" style="width: 100%;">
                <table class="table-equipgo" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Tipo Documento</th>
                            <th>Número Documento</th>
                            <th>Nombre Completo</th>
                            <th>Rol</th>
                            <th>Sede</th>
                            <th>Estado</th>
                            <th>Fecha Creación</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var usuario in usuariosPaginados)
                        {
                            <tr>
                                <td>@usuario.TipoDocumento</td>
                                <td>@usuario.NumeroDocumento</td>
                                <td>@usuario.NombreCompleto</td>
                                <td>@usuario.Rol</td>
                                <td>@usuario.Sede</td>
                                <td>
                                    <span class="badge @(usuario.Estado == "Activo" ? "bg-success" : "bg-danger")">
                                        @usuario.Estado
                                    </span>
                                </td>
                                <td>@usuario.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => EditarUsuario(usuario.Id)" title="Editar">
                                        ✏️
                                    </button>
                                    @*                                     <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => EliminarUsuario(usuario.Id)" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button> *@
                                    <button class="btn btn-sm btn-outline-warning ms-1" @onclick="() => CambiarContraseña(usuario.Id)" title="Cambiar Contraseña">
                                        🔐
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- COMPONENTE DE PAGINACIÓN -->
            <Paginacion TotalRegistros="@usuariosFiltrados.Count"
                        PaginaActual="@paginaActual"
                        PaginaActualChanged="@OnPaginaCambiada"
                        RegistrosPorPagina="@registrosPorPagina"
                        RegistrosPorPaginaChanged="@OnRegistrosPorPaginaCambiados"
                        ModoAuto="@modoAuto"
                        ModoAutoChanged="@OnModoAutoCambiado" />
        }
    </div>
</div>

<!-- Modal Crear Usuario Session -->
<div class="modal fade modal-equipgo" id="modalCrearUsuarioSession" tabindex="-1" aria-labelledby="modalCrearUsuarioSessionLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header-equipgo">
                <h5 class="modal-title-equipgo" id="tituloModalUsuarioSession">
                    @(usuarioEditando == null ? "Crear Usuario Session" : "Editar Usuario Session")
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body-equipgo">
                <EditForm Model="@usuarioForm" OnValidSubmit="@GuardarUsuario" autocomplete="off">
                    <DataAnnotationsValidator />
                    <!-- INPUTS TRAMPA OCULTOS -->
                    <input type="email" style="display: none; height: 0; width: 0; opacity: 0; position: absolute; left: -1000px;" aria-hidden="true" tabindex="-1">
                    <input type="password" style="display: none; height: 0; width: 0; opacity: 0; position: absolute; left: -1000px;" aria-hidden="true" tabindex="-1" autocomplete="new-password">

                    <!-- Sección de Información Personal (Arriba) -->
                    <div class="seccion-modal">
                        <div class="seccion-header">
                            <span class="seccion-titulo">👤 Información Personal</span>
                        </div>
                        <div class="seccion-datos">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-section">
                                        <label>Tipo de Documento <span class="text-danger">*</span></label>
                                        <div class="ts-wrapper">
                                            <InputSelect @bind-Value="usuarioForm.IdTipodocumento" class="ts-control" style="appearance: none; -webkit-appearance: none; -moz-appearance: none;">
                                                <option value="">Seleccionar...</option>
                                                @foreach (var tipoDoc in tiposDocumento)
                                                {
                                                    <option value="@tipoDoc.Id">@tipoDoc.NombreDocumento</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <ValidationMessage For="@(() => usuarioForm.IdTipodocumento)" />
                                    </div>

                                    <div class="form-section">
                                        <label>Número de Documento <span class="text-danger">*</span></label>
                                        <InputText @bind-Value="usuarioForm.NumeroDocumento" placeholder="Ej: 1234567890" autocomplete="off" autocorrect="off" />
                                        <ValidationMessage For="@(() => usuarioForm.NumeroDocumento)" />
                                    </div>

                                    <div class="form-section">
                                        <label>Nombre <span class="text-danger">*</span></label>
                                        <InputText @bind-Value="usuarioForm.Nombre" placeholder="Ej: Juan" autocomplete="off" autocorrect="off" />
                                        <ValidationMessage For="@(() => usuarioForm.Nombre)" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-section">
                                        <label>Apellido <span class="text-danger">*</span></label>
                                        <InputText @bind-Value="usuarioForm.Apellido"
                                                   placeholder="Ej: Pérez"
                                                   autocomplete="off"
                                                   autocorrect="off"
                                                   autocapitalize="off"
                                                   spellcheck="false"
                                                   readonly
                                                   onfocus="this.removeAttribute('readonly')" />
                                        <ValidationMessage For="@(() => usuarioForm.Apellido)" />
                                    </div>

                                    @if (usuarioEditando == null)
                                    {
                                        <div class="form-section">
                                            <label>Contraseña <span class="text-danger">*</span></label>
                                            <InputText type="password"
                                                       @bind-Value="usuarioForm.Contraseña"
                                                       placeholder="Ingrese contraseña"
                                                       autocomplete="new-password"
                                                       autocorrect="off"
                                                       autocapitalize="off"
                                                       spellcheck="false"
                                                       readonly
                                                       onfocus="this.removeAttribute('readonly')" />
                                            <ValidationMessage For="@(() => usuarioForm.Contraseña)" />
                                        </div>

                                        <div class="form-section">
                                            <label>Confirmar Contraseña <span class="text-danger">*</span></label>
                                            <InputText type="password"
                                                       @bind-Value="confirmarContraseña"
                                                       placeholder="Confirme contraseña"
                                                       autocomplete="new-password"
                                                       autocorrect="off"
                                                       autocapitalize="off"
                                                       spellcheck="false"
                                                       readonly
                                                       onfocus="this.removeAttribute('readonly')" />
                                            @if (!string.IsNullOrEmpty(confirmarContraseña) && usuarioForm.Contraseña != confirmarContraseña)
                                            {
                                                <small class="text-danger">Las contraseñas no coinciden</small>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de Información Corporativa (Abajo) -->
                    <div class="seccion-modal mt-3">
                        <div class="seccion-header">
                            <span class="seccion-titulo">🏢 Información Corporativa</span>
                        </div>
                        <div class="seccion-datos">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-section">
                                        <label>Rol <span class="text-danger">*</span></label>
                                        <div class="ts-wrapper">
                                            <InputSelect @bind-Value="usuarioForm.IdRol" class="ts-control" style="appearance: none; -webkit-appearance: none; -moz-appearance: none;">
                                                <option value="">Seleccionar...</option>
                                                @foreach (var rol in roles)
                                                {
                                                    <option value="@rol.Id">@rol.NombreRol</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <ValidationMessage For="@(() => usuarioForm.IdRol)" />
                                    </div>

                                    <div class="form-section">
                                        <label>Sede <span class="text-danger">*</span></label>
                                        <div class="ts-wrapper">
                                            <InputSelect @bind-Value="usuarioForm.IdSede" class="ts-control" style="appearance: none; -webkit-appearance: none; -moz-appearance: none;">
                                                <option value="">Seleccionar...</option>
                                                @foreach (var sede in sedes)
                                                {
                                                    <option value="@sede.Id">@sede.NombreSede</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <ValidationMessage For="@(() => usuarioForm.IdSede)" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-section">
                                        <label>Estado <span class="text-danger">*</span></label>
                                        <div class="ts-wrapper">
                                            <InputSelect @bind-Value="usuarioForm.IdEstado" class="ts-control" style="appearance: none; -webkit-appearance: none; -moz-appearance: none;">
                                                <option value="">Seleccionar...</option>
                                                @foreach (var estado in estados)
                                                {
                                                    <option value="@estado.Id">@estado.NombreEstado</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <ValidationMessage For="@(() => usuarioForm.IdEstado)" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </EditForm>
            </div>
            <div class="modal-footer-equipgo">
                <button class="boton-modal-equipgo boton-modal-secundario" data-bs-dismiss="modal" type="button">Cancelar</button>
                <button class="boton-modal-equipgo" @onclick="GuardarUsuario" disabled="@isGuardando">
                    @if (isGuardando)
                    {
                        <span>
                            <i class="bi bi-arrow-repeat spinner"></i> Guardando...
                        </span>
                    }
                    else
                    {
                        <span>@(usuarioEditando == null ? "Guardar" : "Actualizar")</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cambiar Contraseña -->
<div class="modal fade modal-equipgo" id="modalCambiarContraseña" tabindex="-1" aria-labelledby="modalCambiarContraseñaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header-equipgo">
                <h5 class="modal-title-equipgo">Cambiar Contraseña</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body-equipgo">
                <EditForm Model="@cambioContraseñaForm" OnValidSubmit="@ProcesarCambioContraseña" autocomplete="off">
                    <DataAnnotationsValidator />
                    <!-- INPUTS TRAMPA OCULTOS -->
                    <input type="email" style="display: none; height: 0; width: 0; opacity: 0; position: absolute; left: -1000px;" aria-hidden="true" tabindex="-1">
                    <input type="password" style="display: none; height: 0; width: 0; opacity: 0; position: absolute; left: -1000px;" aria-hidden="true" tabindex="-1" autocomplete="new-password">

                    <div class="seccion-modal">
                        <div class="seccion-datos">
                            <div class="form-section">
                                <label>Nueva Contraseña <span class="text-danger">*</span></label>
                                <InputText type="password"
                                           @bind-Value="cambioContraseñaForm.NuevaContraseña"
                                           class="form-control"
                                           autocomplete="new-password"
                                           autocorrect="off"
                                           autocapitalize="off"
                                           spellcheck="false"
                                           readonly
                                           onfocus="this.removeAttribute('readonly')" />
                                <ValidationMessage For="@(() => cambioContraseñaForm.NuevaContraseña)" />
                            </div>
                            <div class="form-section">
                                <label>Confirmar Contraseña <span class="text-danger">*</span></label>
                                <InputText type="password"
                                           @bind-Value="cambioContraseñaForm.ConfirmarContraseña"
                                           class="form-control"
                                           autocomplete="new-password"
                                           autocorrect="off"
                                           autocapitalize="off"
                                           spellcheck="false"
                                           readonly
                                           onfocus="this.removeAttribute('readonly')" />
                                <ValidationMessage For="@(() => cambioContraseñaForm.ConfirmarContraseña)" />
                                @if (!string.IsNullOrEmpty(cambioContraseñaForm.ConfirmarContraseña) && cambioContraseñaForm.NuevaContraseña != cambioContraseñaForm.ConfirmarContraseña)
                                {
                                    <small class="text-danger">Las contraseñas no coinciden</small>
                                }
                            </div>
                        </div>
                    </div>
                </EditForm>
            </div>
            <div class="modal-footer-equipgo">
                <button class="boton-modal-equipgo boton-modal-secundario" data-bs-dismiss="modal" type="button">Cancelar</button>
                <button class="boton-modal-equipgo" @onclick="ProcesarCambioContraseña" disabled="@isCambiandoContraseña">
                    @if (isCambiandoContraseña)
                    {
                        <span>
                            <i class="bi bi-arrow-repeat spinner"></i> Cambiando...
                        </span>
                    }
                    else
                    {
                        <span>Cambiar Contraseña</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 50;
        pointer-events: none;
    }

    .spinner-container {
        position: relative;
        width: 56px;
        height: 56px;
    }

    .spinner-equipgo {
        width: 56px;
        height: 56px;
        border: 4px solid #ef4444;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin-slow 1.4s linear infinite;
    }

    .loading-text {
        margin-top: 12px;
        color: #ef4444;
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.025em;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @@keyframes spin-slow {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @@keyframes pulse {
        0%, 100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .spinner {
        animation: spin-slow 1s linear infinite;
    }

    .form-section {
        margin-bottom: 1rem;
    }

        .form-section label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }

    .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>